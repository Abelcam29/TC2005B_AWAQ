<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Asistente de Convocatorias - Mawi</title>
    <meta name="description" content="Asistente de Convocatorias" />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="css/sidebar-styles.css" />
  </head>
  
  <body data-page="convocatorias">
    <div class="mawi-app-container">
      <header class="mawi-header">        
        <div class="logo">
          <img src="eye-icon.svg" alt="Mawi" class="eye-icon" />
          <h2>Mawi</h2>
        </div>
        
        <div class="user-menu">
          <span>Usuario</span>
          <div class="avatar-circle">
            <img src="avatar-placeholder.svg" alt="Usuario" />
          </div>
          <button onclick="logout()" class="logout-btn" title="Cerrar sesi√≥n">
            üö™
          </button>
        </div>
      </header>
      
      <!-- Bot√≥n toggle de la sidebar -->
      <button class="sidebar-toggle" id="sidebarToggle" aria-label="Abrir/cerrar men√∫ lateral">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9,18 15,12 9,6"></polyline>
        </svg>
      </button>

      <div class="app-content with-sidebar">
        <!-- Contenedor para la sidebar -->
        <div id="sidebar-container"></div>

        <!-- Main content -->
        <main class="main-content">
          <div class="convocatorias-header">
            <h1>Asistente de Convocatorias</h1>
            <!-- ‚úÖ NUEVO: Bot√≥n crear convocatoria -->
            <button class="crear-convocatoria-btn" onclick="openModal()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Crear Convocatoria
            </button>
          </div>

          <!-- ‚úÖ NUEVO: Visualizaci√≥n de convocatorias a pantalla completa -->
          <div class="convocatorias-display-section">
            <!-- ‚úÖ NUEVO: Tabs horizontales -->
            <div class="convocatorias-tabs-container">
              <div class="convocatorias-tabs">
                <button class="tab-button active" data-tab="abiertas">
                  Abiertos
                </button>
                <button class="tab-button" data-tab="cerradas">
                  Cerrados
                </button>
              </div>
            </div>

            <!-- Tab de Convocatorias Abiertas -->
            <div class="tab-content active" id="tab-abiertas">
              <div class="convocatorias-grid">
                <!-- Ejemplo de convocatoria abierta -->
                <div class="convocatoria-card abierta">
                  <div class="card-header">
                    <h3>Investigaci√≥n Biodiversidad Marina</h3>
                    <span class="status-badge abierta">Abierta</span>
                  </div>
                  <div class="card-body">
                    <p class="descripcion">Proyecto de investigaci√≥n para el estudio de ecosistemas marinos en el Pac√≠fico.</p>
                    <div class="card-meta">
                      <div class="meta-item">
                        <strong>Organizaci√≥n:</strong> CONACYT
                      </div>
                      <div class="meta-item">
                        <strong>Regi√≥n:</strong> Pac√≠fico Mexicano
                      </div>
                      <div class="meta-item">
                        <strong>Cierra:</strong> 15 Enero 2025
                      </div>
                    </div>
                  </div>
                  <div class="card-actions">
                    <button class="btn-secondary" onclick="viewConvocatoria(1)">Ver detalles</button>
                    <button class="btn-primary" onclick="applyConvocatoria(1)">Aplicar</button>
                  </div>
                </div>

                <!-- Ejemplo 2 -->
                <div class="convocatoria-card abierta">
                  <div class="card-header">
                    <h3>Conservaci√≥n de Bosques Tropicales</h3>
                    <span class="status-badge abierta">Abierta</span>
                  </div>
                  <div class="card-body">
                    <p class="descripcion">Iniciativa para la protecci√≥n y restauraci√≥n de bosques tropicales.</p>
                    <div class="card-meta">
                      <div class="meta-item">
                        <strong>Organizaci√≥n:</strong> WWF M√©xico
                      </div>
                      <div class="meta-item">
                        <strong>Regi√≥n:</strong> Chiapas, M√©xico
                      </div>
                      <div class="meta-item">
                        <strong>Cierra:</strong> 28 Enero 2025
                      </div>
                    </div>
                  </div>
                  <div class="card-actions">
                    <button class="btn-secondary" onclick="viewConvocatoria(2)">Ver detalles</button>
                    <button class="btn-primary" onclick="applyConvocatoria(2)">Aplicar</button>
                  </div>
                </div>

                <!-- Ejemplo 3 -->
                <div class="convocatoria-card abierta">
                  <div class="card-header">
                    <h3>Monitoreo de Aves Migratorias</h3>
                    <span class="status-badge abierta">Abierta</span>
                  </div>
                  <div class="card-body">
                    <p class="descripcion">Programa de seguimiento de rutas migratorias y poblaci√≥n de aves.</p>
                    <div class="card-meta">
                      <div class="meta-item">
                        <strong>Organizaci√≥n:</strong> NABCI M√©xico
                      </div>
                      <div class="meta-item">
                        <strong>Regi√≥n:</strong> Nacional
                      </div>
                      <div class="meta-item">
                        <strong>Cierra:</strong> 10 Febrero 2025
                      </div>
                    </div>
                  </div>
                  <div class="card-actions">
                    <button class="btn-secondary" onclick="viewConvocatoria(3)">Ver detalles</button>
                    <button class="btn-primary" onclick="applyConvocatoria(3)">Aplicar</button>
                  </div>
                </div>

                <!-- Ejemplo 4 -->
                <div class="convocatoria-card abierta">
                  <div class="card-header">
                    <h3>Estudio de Especies End√©micas</h3>
                    <span class="status-badge abierta">Abierta</span>
                  </div>
                  <div class="card-body">
                    <p class="descripcion">Investigaci√≥n sobre especies end√©micas en zonas de alta biodiversidad.</p>
                    <div class="card-meta">
                      <div class="meta-item">
                        <strong>Organizaci√≥n:</strong> SEMARNAT
                      </div>
                      <div class="meta-item">
                        <strong>Regi√≥n:</strong> Oaxaca, M√©xico
                      </div>
                      <div class="meta-item">
                        <strong>Cierra:</strong> 5 Febrero 2025
                      </div>
                    </div>
                  </div>
                  <div class="card-actions">
                    <button class="btn-secondary" onclick="viewConvocatoria(4)">Ver detalles</button>
                    <button class="btn-primary" onclick="applyConvocatoria(4)">Aplicar</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tab de Convocatorias Cerradas -->
            <div class="tab-content" id="tab-cerradas">
              <div class="convocatorias-grid">
                <!-- Ejemplo de convocatoria cerrada -->
                <div class="convocatoria-card cerrada">
                  <div class="card-header">
                    <h3>Estudio de Corales del Caribe</h3>
                    <span class="status-badge cerrada">Cerrada</span>
                  </div>
                  <div class="card-body">
                    <p class="descripcion">Investigaci√≥n sobre el estado de los arrecifes coralinos.</p>
                    <div class="card-meta">
                      <div class="meta-item">
                        <strong>Organizaci√≥n:</strong> UNAM
                      </div>
                      <div class="meta-item">
                        <strong>Regi√≥n:</strong> Quintana Roo
                      </div>
                      <div class="meta-item">
                        <strong>Cerr√≥:</strong> 20 Diciembre 2024
                      </div>
                    </div>
                  </div>
                  <div class="card-actions">
                    <button class="btn-secondary" onclick="viewConvocatoria(5)">Ver detalles</button>
                    <span class="status-text">Convocatoria cerrada</span>
                  </div>
                </div>

                <!-- Ejemplo 2 cerrada -->
                <div class="convocatoria-card cerrada">
                  <div class="card-header">
                    <h3>Programa de Reforestaci√≥n Urbana</h3>
                    <span class="status-badge cerrada">Cerrada</span>
                  </div>
                  <div class="card-body">
                    <p class="descripcion">Iniciativa para aumentar la cobertura vegetal en √°reas urbanas.</p>
                    <div class="card-meta">
                      <div class="meta-item">
                        <strong>Organizaci√≥n:</strong> Gobierno CDMX
                      </div>
                      <div class="meta-item">
                        <strong>Regi√≥n:</strong> Ciudad de M√©xico
                      </div>
                      <div class="meta-item">
                        <strong>Cerr√≥:</strong> 10 Diciembre 2024
                      </div>
                    </div>
                  </div>
                  <div class="card-actions">
                    <button class="btn-secondary" onclick="viewConvocatoria(6)">Ver detalles</button>
                    <span class="status-text">Convocatoria cerrada</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- ‚úÖ NUEVO: Modal para crear convocatoria -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
      <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h2>Nueva Convocatoria</h2>
          <button class="modal-close" onclick="closeModal()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
              <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>

        <div class="modal-body">
          <form id="convocatoriaForm" class="convocatorias-form">
            <div class="form-row">
              <div class="form-group">
                <label for="convocatoria-name">Nombre de la convocatoria</label>
                <input 
                  type="text" 
                  id="convocatoria-name"
                  class="form-input" 
                  placeholder="¬øC√≥mo vas a llamar a tu propuesta?"
                  required
                />
              </div>

              <div class="form-group">
                <label for="fecha-cierre">Fecha de cierre</label>
                <input 
                  type="date" 
                  id="fecha-cierre"
                  class="form-input"
                  required
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="sitio-web">Sitio web</label>
                <input 
                  type="url" 
                  id="sitio-web"
                  class="form-input" 
                  placeholder="https://ejemplo.com"
                />
              </div>
              
              <div class="form-group">
                <label for="region">Regi√≥n</label>
                <input 
                  type="text" 
                  id="region"
                  class="form-input" 
                  placeholder="¬øEn qu√© regi√≥n se organiza?"
                  required
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="organizacion">Organizaci√≥n</label>
                <input 
                  type="text" 
                  id="organizacion"
                  class="form-input" 
                  placeholder="Nombre de la organizaci√≥n"
                  required
                />
              </div>
              
              <div class="form-group">
                <label for="pais">Pa√≠s o Zona Geogr√°fica</label>
                <input 
                  type="text" 
                  id="pais"
                  class="form-input" 
                  placeholder="¬øPara qu√© lugar se plantea?"
                  required
                />
              </div>
            </div>
            
            <div class="form-group">
              <label for="descripcion">Descripci√≥n</label>
              <textarea
                id="descripcion"
                class="form-input" 
                placeholder="Descripci√≥n de qu√© va a ser el proyecto"
                rows="4"
                required
              ></textarea>
            </div>
          </form>
        </div>

        <!-- ‚úÖ AGREGAR: Footer del modal con los botones -->
        <div class="modal-footer">
          <button class="btn-primary" onclick="submitConvocatoria()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Crear Convocatoria
          </button>
        </div>
      </div>
    </div>

    <script src="https://cdn.gpteng.co/gptengineer.js" type="module"></script>
    <script src="js/sidebar-loader.js"></script>
    <script src="js/admin-button.js"></script>
    <script>
      // ‚úÖ NUEVO: Funcionalidad de modal
      function openModal() {
        const modal = document.getElementById('modalOverlay');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Enfocar primer input
        setTimeout(() => {
          const firstInput = document.getElementById('convocatoria-name');
          if (firstInput) {
            firstInput.focus();
          }
        }, 300);
      }

      function closeModal() {
        const modal = document.getElementById('modalOverlay');
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
        
        // Limpiar formulario despu√©s de la animaci√≥n
        setTimeout(() => {
          document.getElementById('convocatoriaForm').reset();
        }, 300);
      }

      // ‚úÖ NUEVO: Efectos de focus en los inputs
      document.addEventListener('DOMContentLoaded', function() {
        // Efectos para inputs
        const inputs = document.querySelectorAll('.form-input');
        inputs.forEach(input => {
          input.addEventListener('focus', function() {
            this.closest('.form-group').classList.add('focused');
          });
          
          input.addEventListener('blur', function() {
            this.closest('.form-group').classList.remove('focused');
          });
        });

        // Manejar tabs
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
          button.addEventListener('click', () => {
            const tabName = button.dataset.tab;
            
            // Remover clase active de todos los tabs
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Agregar clase active al tab seleccionado
            button.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
          });
        });

        // Cerrar modal con tecla Escape
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            closeModal();
          }
        });

        loadUserName();
      });

      // ‚úÖ MEJORADO: Submit con loading
      function submitConvocatoria() {
        const form = document.getElementById('convocatoriaForm');
        const submitBtn = document.querySelector('.modal-footer .btn-primary');
        
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        // Mostrar loading
        submitBtn.classList.add('btn-loading');
        submitBtn.textContent = 'Creando...';

        const formData = {
          nombre: document.getElementById('convocatoria-name').value,
          fechaCierre: document.getElementById('fecha-cierre').value,
          sitioWeb: document.getElementById('sitio-web').value,
          region: document.getElementById('region').value,
          organizacion: document.getElementById('organizacion').value,
          pais: document.getElementById('pais').value,
          descripcion: document.getElementById('descripcion').value
        };
        
        console.log('Datos de la convocatoria:', formData);
        
        // Simular llamada al backend
        setTimeout(() => {
          // Remover loading
          submitBtn.classList.remove('btn-loading');
          submitBtn.innerHTML = `
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Crear Convocatoria
          `;
          
          // TODO: Aqu√≠ ir√° la llamada real al backend
          alert('¬°Convocatoria creada exitosamente!\n(Backend en desarrollo)');
          closeModal();
        }, 1500);
      }

      function viewConvocatoria(id) {
        console.log('Ver convocatoria:', id);
        alert(`Ver detalles de convocatoria ${id} - Funci√≥n en desarrollo`);
      }

      function applyConvocatoria(id) {
        console.log('Aplicar a convocatoria:', id);
        alert(`Aplicar a convocatoria ${id} - Funci√≥n en desarrollo`);
      }

      // ‚úÖ CORREGIR: Sistema de b√∫squeda y paginaci√≥n que funciona con el HTML existente
      class ConvocatoriasManager {
        constructor() {
          this.convocatorias = {
            abiertas: [
              {
                id: 1,
                nombre: "Investigaci√≥n Biodiversidad Marina",
                descripcion: "Proyecto de investigaci√≥n para el estudio de ecosistemas marinos en el Pac√≠fico.",
                organizacion: "CONACYT",
                region: "Pac√≠fico Mexicano",
                fechaCierre: "15 Enero 2025",
                estado: "abierta"
              },
              {
                id: 2,
                nombre: "Conservaci√≥n de Bosques Tropicales",
                descripcion: "Iniciativa para la protecci√≥n y restauraci√≥n de bosques tropicales.",
                organizacion: "WWF M√©xico",
                region: "Chiapas, M√©xico",
                fechaCierre: "28 Enero 2025",
                estado: "abierta"
              },
              {
                id: 3,
                nombre: "Monitoreo de Aves Migratorias",
                descripcion: "Programa de seguimiento de rutas migratorias y poblaci√≥n de aves.",
                organizacion: "NABCI M√©xico",
                region: "Corredor Biol√≥gico Mesoamericano",
                fechaCierre: "10 Febrero 2025",
                estado: "abierta"
              },
              {
                id: 4,
                nombre: "Restauraci√≥n de Arrecifes de Coral",
                descripcion: "Proyecto de rehabilitaci√≥n de ecosistemas coralinos afectados por el cambio clim√°tico.",
                organizacion: "CONANP",
                region: "Caribe Mexicano",
                fechaCierre: "20 Febrero 2025",
                estado: "abierta"
              },
              {
                id: 5,
                nombre: "Conservaci√≥n de Especies End√©micas",
                descripcion: "Programa de protecci√≥n de flora y fauna end√©mica de M√©xico.",
                organizacion: "SEMARNAT",
                region: "Nacional",
                fechaCierre: "05 Marzo 2025",
                estado: "abierta"
              }
            ],
            cerradas: [
              {
                id: 6,
                nombre: "Estudio de Contaminaci√≥n Acu√°tica",
                descripcion: "An√°lisis de calidad del agua en cuerpos lacustres urbanos.",
                organizacion: "IMTA",
                region: "Valle de M√©xico",
                fechaCierre: "15 Diciembre 2024",
                estado: "cerrada"
              },
              {
                id: 7,
                nombre: "Programa de Reforestaci√≥n Urbana",
                descripcion: "Iniciativa de plantaci√≥n de √°rboles nativos en zonas metropolitanas.",
                organizacion: "SEDEMA",
                region: "Ciudad de M√©xico",
                fechaCierre: "30 Noviembre 2024",
                estado: "cerrada"
              }
            ]
          };
          
          this.currentTab = 'abiertas';
          this.currentPage = 1;
          this.itemsPerPage = 4;
          this.searchTerm = '';
          this.filteredData = [];
          
          this.initializeComponents();
        }

        initializeComponents() {
          this.addSearchBarToExistingHTML();
          this.addPaginationToExistingHTML();
          this.setupExistingTabs();
          this.updateDisplay();
        }

        addSearchBarToExistingHTML() {
          // Agregar barra de b√∫squeda despu√©s del header
          const header = document.querySelector('.convocatorias-header');
          const searchHTML = `
            <div class="convocatorias-controls">
              <div class="search-container">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="8"></circle>
                  <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input 
                  type="text" 
                  class="search-input" 
                  placeholder="Buscar convocatorias por nombre..."
                  id="convocatoria-search"
                >
                <button class="search-clear" id="search-clear">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
            </div>
            
            <div class="results-count" id="results-count"></div>
          `;
          
          header.insertAdjacentHTML('afterend', searchHTML);
          this.setupSearchEvents();
        }

        addPaginationToExistingHTML() {
          // Agregar paginaci√≥n despu√©s de cada tab-content
          const tabContents = document.querySelectorAll('.tab-content');
          tabContents.forEach(tabContent => {
            const paginationHTML = `
              <div class="pagination-container" id="pagination-${tabContent.id}"></div>
            `;
            tabContent.insertAdjacentHTML('afterend', paginationHTML);
          });
        }

        setupExistingTabs() {
          // Usar los tabs existentes del HTML
          const tabButtons = document.querySelectorAll('.tab-button');
          tabButtons.forEach(button => {
            button.addEventListener('click', () => {
              const tab = button.dataset.tab;
              if (tab !== this.currentTab) {
                this.currentTab = tab;
                this.currentPage = 1;
                this.updateDisplay();
              }
            });
          });
        }

        setupSearchEvents() {
          const searchInput = document.getElementById('convocatoria-search');
          const searchClear = document.getElementById('search-clear');
          const searchContainer = document.querySelector('.search-container');

          searchInput.addEventListener('input', (e) => {
            this.searchTerm = e.target.value.trim();
            this.currentPage = 1;
            
            if (this.searchTerm) {
              searchContainer.classList.add('has-text', 'searching');
            } else {
              searchContainer.classList.remove('has-text', 'searching');
            }
            
            setTimeout(() => {
              searchContainer.classList.remove('searching');
              this.updateDisplay();
            }, 300);
          });

          searchClear.addEventListener('click', () => {
            searchInput.value = '';
            this.searchTerm = '';
            this.currentPage = 1;
            searchContainer.classList.remove('has-text');
            this.updateDisplay();
            searchInput.focus();
          });
        }

        filterData() {
          const data = this.convocatorias[this.currentTab];
          
          if (!this.searchTerm) {
            this.filteredData = data;
            return;
          }

          this.filteredData = data.filter(convocatoria => 
            convocatoria.nombre.toLowerCase().includes(this.searchTerm.toLowerCase())
          );
        }

        highlightSearchTerm(text) {
          if (!this.searchTerm) return text;
          
          const regex = new RegExp(`(${this.searchTerm})`, 'gi');
          return text.replace(regex, '<span class="highlight">$1</span>');
        }

        renderConvocatorias() {
          // Actualizar el grid existente en lugar de crear uno nuevo
          const activeTabContent = document.querySelector('.tab-content.active');
          const grid = activeTabContent.querySelector('.convocatorias-grid');
          
          const startIndex = (this.currentPage - 1) * this.itemsPerPage;
          const endIndex = startIndex + this.itemsPerPage;
          const pageData = this.filteredData.slice(startIndex, endIndex);

          if (pageData.length === 0) {
            grid.innerHTML = `
              <div class="convocatorias-empty">
                <div class="empty-icon">üîç</div>
                <h3>${this.searchTerm ? 'No se encontraron resultados' : 'No hay convocatorias'}</h3>
                <p>${this.searchTerm ? 
                  `No se encontraron convocatorias que coincidan con "${this.searchTerm}"` : 
                  `No hay convocatorias ${this.currentTab} disponibles en este momento`
                }</p>
              </div>
            `;
            return;
          }

          grid.innerHTML = pageData.map(convocatoria => `
            <div class="convocatoria-card ${convocatoria.estado}">
              <div class="card-header">
                <h3>${this.highlightSearchTerm(convocatoria.nombre)}</h3>
                <span class="status-badge ${convocatoria.estado}">${convocatoria.estado}</span>
              </div>
              <div class="card-body">
                <p class="descripcion">${convocatoria.descripcion}</p>
                <div class="card-meta">
                  <div class="meta-item">
                    <strong>Organizaci√≥n:</strong> ${convocatoria.organizacion}
                  </div>
                  <div class="meta-item">
                    <strong>Regi√≥n:</strong> ${convocatoria.region}
                  </div>
                  <div class="meta-item">
                    <strong>Cierra:</strong> ${convocatoria.fechaCierre}
                  </div>
                </div>
              </div>
              <div class="card-actions">
                ${convocatoria.estado === 'abierta' ? 
                  `<button class="btn-primary" onclick="applyConvocatoria(${convocatoria.id})">Aplicar</button>` : 
                  '<span class="status-text">Cerrada</span>'
                }
                <button class="btn-secondary" onclick="viewConvocatoria(${convocatoria.id})">Ver detalles</button>
              </div>
            </div>
          `).join('');
        }

        renderPagination() {
          const activeTabContent = document.querySelector('.tab-content.active');
          const container = document.querySelector(`#pagination-${activeTabContent.id}`);
          const totalPages = Math.ceil(this.filteredData.length / this.itemsPerPage);
          
          if (totalPages <= 1) {
            container.innerHTML = '';
            return;
          }

          const startItem = (this.currentPage - 1) * this.itemsPerPage + 1;
          const endItem = Math.min(this.currentPage * this.itemsPerPage, this.filteredData.length);

          container.innerHTML = `
            <div class="pagination-info">
              Mostrando ${startItem}-${endItem} de ${this.filteredData.length} convocatorias
            </div>
            
            <div class="pagination-controls">
              <button class="pagination-btn prev" ${this.currentPage === 1 ? 'disabled' : ''}>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15,18 9,12 15,6"></polyline>
                </svg>
              </button>
              
              <div class="pagination-pages">
                ${this.generatePageButtons(totalPages)}
              </div>
              
              <button class="pagination-btn next" ${this.currentPage === totalPages ? 'disabled' : ''}>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9,18 15,12 9,6"></polyline>
                </svg>
              </button>
            </div>
          `;
          
          this.setupPaginationEvents();
        }

        generatePageButtons(totalPages) {
          let buttons = '';
          const maxVisible = 5;
          
          let startPage = Math.max(1, this.currentPage - Math.floor(maxVisible / 2));
          let endPage = Math.min(totalPages, startPage + maxVisible - 1);
          
          if (endPage - startPage + 1 < maxVisible) {
            startPage = Math.max(1, endPage - maxVisible + 1);
          }

          for (let i = startPage; i <= endPage; i++) {
            buttons += `
              <button class="pagination-btn ${i === this.currentPage ? 'active' : ''}" data-page="${i}">
                ${i}
              </button>
            `;
          }
          
          return buttons;
        }

        setupPaginationEvents() {
          const activeTabContent = document.querySelector('.tab-content.active');
          const container = document.querySelector(`#pagination-${activeTabContent.id}`);
          
          const prevBtn = container.querySelector('.pagination-btn.prev');
          const nextBtn = container.querySelector('.pagination-btn.next');
          const pageButtons = container.querySelectorAll('.pagination-btn[data-page]');

          prevBtn?.addEventListener('click', () => {
            if (this.currentPage > 1) {
              this.currentPage--;
              this.updateDisplay();
            }
          });

          nextBtn?.addEventListener('click', () => {
            const totalPages = Math.ceil(this.filteredData.length / this.itemsPerPage);
            if (this.currentPage < totalPages) {
              this.currentPage++;
              this.updateDisplay();
            }
          });

          pageButtons.forEach(button => {
            button.addEventListener('click', () => {
              this.currentPage = parseInt(button.dataset.page);
              this.updateDisplay();
            });
          });
        }

        updateResultsCount() {
          const resultsCount = document.getElementById('results-count');
          const total = this.filteredData.length;
          const totalOriginal = this.convocatorias[this.currentTab].length;
          
          if (this.searchTerm) {
            resultsCount.innerHTML = `
              <strong>${total}</strong> de <strong>${totalOriginal}</strong> convocatorias 
              ${this.currentTab} encontradas para "<strong>${this.searchTerm}</strong>"
            `;
          } else {
            resultsCount.innerHTML = `
              <strong>${total}</strong> convocatorias ${this.currentTab} disponibles
            `;
          }
        }

        updateDisplay() {
          this.filterData();
          this.updateResultsCount();
          this.renderConvocatorias();
          this.renderPagination();
        }
      }

      // ‚úÖ Inicializar el sistema cuando cargue la p√°gina
      document.addEventListener('DOMContentLoaded', function() {
        // Solo inicializar si estamos en la p√°gina de convocatorias
        if (document.body.dataset.page === 'convocatorias') {
          new ConvocatoriasManager();
        }
        
        // ... resto del c√≥digo existente ...
        loadUserName();
      });
      
      // Funciones existentes...
      function decodeJWT(token) {
        try {
          const parts = token.split('.');
          if (parts.length !== 3) {
            throw new Error('Token invalido');
          }

          const payload = parts[1];
          const paddedPayload = payload + '='.repeat((4 - payload.length % 4) % 4);
          const decodedPayload = atob(paddedPayload);
          return JSON.parse(decodedPayload);
        } catch(error) {
          console.error('Error al decodificar token', error);
          return null;
        }
      }

      async function loadUserName() {
        try {
          const token = localStorage.getItem('token');
          if(!token) {
            console.log('No se encontro token');
            window.location.href = 'login.html';
            return;
          }

          const payload = decodeJWT(token);
          if(!payload) {
            console.error('No se pudo deocidificar el token');
            localStorage.removeItem('token');
            window.location.href = 'login.html';
            return;
          }

          console.log('Payload del token:', payload);

          let username = 'us';

          if(payload.nombre) {
            username = `${payload.nombre}`;
          }

          await loadUserProfileImage(payload.id, token, username);

          const userMenuSpan = document.querySelector('.user-menu span');
          if(userMenuSpan) {
            userMenuSpan.textContent = username;
            console.log('Nombre de usuario actualizado')
          }
          else {
            console.error('No se encontro el elemento');
          }

          if(payload.exp) {
            const currentTime = Math.floor(Date.now() / 1000);
            if(payload.exp < currentTime) {
              console.log('Token expirado, redirigiendo a login');
              localStorage.removeItem('token');
              window.location.href = 'login.html';
              return;
            }
          }
        } catch (error) {
          console.error('Error cargando nombre de usuario:', error);
          localStorage.removeItem('token');
          window.location.href = 'login.html';
        }
      }

      async function loadUserProfileImage(userId, token, username) {
        try {
          if(!userId) {
            console.log('No se encontro ID de usuario');
            return;
          }

          const response =  await fetch(`/Consultas/api/getUserProfileImage/${userId}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if(!response.ok) {
            console.log('No se encontro imagen de perfil')
            return;
          }

          const data = await response.json();

          if(data.status === 'success' && data.imageName) {
            const imageUrl = `/uploads/usuarios/${data.imageName}`;

            const avatarImg = document.querySelector('.avatar-circle img');
            if(avatarImg) {
              avatarImg.src = imageUrl;
              avatarImg.alt = `${username} - Perfil`; 
            } else
            {
              console.error('Usuario no tiene imagen');
            }
            
          } else {
            console.error('Error al obtener imagen de perfil');
          }
        } catch (error) {
          console.log('Error al cargar imagen de perfil:', error);
        }
      }

      function logout() {
        localStorage.removeItem('token');
        window.location.href = 'login.html';
      }
    </script>
  </body>
</html>