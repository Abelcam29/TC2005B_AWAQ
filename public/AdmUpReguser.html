<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Usuarios - MAWI Super Admin</title>
    <link rel="stylesheet" href="css/admin-dashboard-stats.css">
    <link rel="stylesheet" href="css/notification.css">
    <link rel="stylesheet" href="css/loading.css">
    <style>
        /* ‚úÖ ESTILOS PARA BOT√ìN QUE SE MUEVE CON LA SIDEBAR */
        .sidebar-toggle {
            position: fixed;
            top: 20px;
            left: 20px; /* ‚úÖ POSICI√ìN INICIAL CUANDO SIDEBAR EST√Å CERRADA */
            z-index: 1000;
            background: var(--admin-primary, #48cc6c);
            border: none;
            border-radius: 8px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease; /* ‚úÖ TRANSICI√ìN SUAVE PARA EL MOVIMIENTO */
        }

        .sidebar-toggle:hover {
            background: var(--admin-primary-dark, #3da458);
            transform: scale(1.05);
        }

        /* ‚úÖ CLASE PARA CUANDO LA SIDEBAR EST√Å ABIERTA */
        .sidebar-toggle.sidebar-open {
            left: 300px; /* ‚úÖ SE MUEVE A LA DERECHA CUANDO SIDEBAR EST√Å ABIERTA (280px + 20px margin) */
        }

        /* ‚úÖ RESPONSIVE - EN M√ìVIL EL BOT√ìN SE COMPORTA DIFERENTE */
        @media (max-width: 1023px) {
            .sidebar-toggle {
                left: 20px !important; /* ‚úÖ EN M√ìVIL SIEMPRE SE QUEDA EN LA MISMA POSICI√ìN */
            }
        }

        /* ‚úÖ ESTILOS ADICIONALES PARA TABLAS EXPANDIBLES */
        .expandable-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .expandable-row:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .admin-expandable-content {
            display: none;
            background-color: rgba(0, 0, 0, 0.01);
        }

        .admin-expandable-content.show {
            display: table-row;
        }

        .admin-expandable-inner {
            padding: 1rem;
            border-left: 3px solid var(--admin-primary);
            background: rgba(72, 204, 108, 0.05);
            border-radius: 4px;
            margin: 0.5rem 0;
        }

        .admin-expandable-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .admin-expandable-title {
            margin: 0;
            color: var(--admin-text-primary);
            font-size: 1.1rem;
        }

        .admin-collapse-btn {
            background: var(--admin-primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .admin-collapse-btn:hover {
            background: var(--admin-primary-dark, #3da458);
        }
    </style>
</head>
<body data-page="gestion-usuarios">
    <div class="admin-app-container">
        <!-- Header -->
        <header class="admin-header">
            <div class="admin-logo">
                <div class="admin-logo-icon">M</div>
                <h1>MAWI Super Admin</h1>
            </div>
            <div class="admin-user-menu">
                <div class="admin-user-info">
                    <div class="admin-avatar" id="userAvatar">SA</div>
                    <div>
                        <div class="admin-username" id="userName">Super Admin</div>
                        <div class="admin-user-role" id="userRole">Sistema</div>
                    </div>
                </div>
                <button class="admin-btn admin-btn-secondary" onclick="logout()">
                    <span>üö™</span> Cerrar Sesi√≥n
                </button>
            </div>
        </header>

        <!-- ‚úÖ BOT√ìN SIDEBAR QUE SE MUEVE -->
        <button class="sidebar-toggle" onclick="toggleSidebar()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9,18 15,12 9,6"></polyline>
            </svg>
        </button>

        <div class="admin-content-wrapper">
            <!-- Sidebar Container -->
            <div id="sidebar-container"></div>

            <!-- Main Content -->
            <main class="admin-main-content">
                <!-- ‚úÖ PAGE HEADER -->
                <div class="page-header">
                    <div>
                        <h1 class="page-title">‚öôÔ∏è Gesti√≥n de Usuarios</h1>
                        <p class="page-subtitle">Administra usuarios activos y visualiza sus registros</p>
                    </div>
                    <div class="page-actions">
                        <button class="admin-btn admin-btn-primary" onclick="loadUsuarios()">
                            <span>üîÑ</span> Actualizar Lista
                        </button>
                        <select class="admin-btn admin-btn-secondary" id="statusFilter" onchange="filterUsers()">
                            <option value="">Todos los estados</option>
                            <option value="A">Activos</option>
                            <option value="I">Inactivos</option>
                            <option value="S">Suspendidos</option>
                        </select>
                    </div>
                </div>

                <!-- Stats Card -->
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 2rem;">
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-content">
                            <h3 class="stat-title">Total Usuarios</h3>
                            <p class="stat-value" id="userCount">0</p>
                            <p class="stat-change">Usuarios registrados</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-content">
                            <h3 class="stat-title">Usuarios Activos</h3>
                            <p class="stat-value" id="activeCount">0</p>
                            <p class="stat-change">Con acceso al sistema</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-content">
                            <h3 class="stat-title">Total Registros</h3>
                            <p class="stat-value" id="totalRecords">0</p>
                            <p class="stat-change">Registros de biodiversidad</p>
                        </div>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3>Lista de Usuarios</h3>
                    </div>
                    <div class="admin-table-container">
                        <table class="admin-table" id="usersTable">
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>Email</th>
                                    <th>Rol</th>
                                    <th>Estado</th>
                                    <th>Registros</th>
                                    <th>√öltima Actividad</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="user-table-body">
                                <tr>
                                    <td colspan="7" class="admin-loading">
                                        <div class="admin-spinner"></div>
                                        Cargando usuarios...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="admin-card" style="display: none; text-align: center; padding: 3rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üë•</div>
                    <h3 style="margin: 0 0 0.5rem 0; color: var(--admin-text-primary);">No se encontraron usuarios</h3>
                    <p style="color: var(--admin-text-secondary); margin: 0;">Ajusta los filtros para ver m√°s resultados</p>
                </div>
            </main>
        </div>
    </div>

    <script src="js/notification.js"></script>
    <script src="js/loading.js"></script>
    <script>
        // ‚úÖ VARIABLE GLOBAL PARA ESTADO DE SIDEBAR
        let sidebarIsOpen = false;

        // ‚úÖ FUNCI√ìN SIMPLE PARA TOGGLE SIDEBAR CON MOVIMIENTO DE BOT√ìN
        function toggleSidebar() {
            const sidebar = document.querySelector('.admin-sidebar');
            const toggleBtn = document.querySelector('.sidebar-toggle');
            
            if (!sidebar || !toggleBtn) {
                console.log('‚ö†Ô∏è Sidebar o bot√≥n no encontrado');
                return;
            }
            
            console.log('üîÑ Toggle sidebar - Estado actual:', sidebarIsOpen);
            
            if (sidebarIsOpen) {
                // ‚úÖ CERRAR SIDEBAR
                sidebar.style.transform = 'translateX(-100%)';
                toggleBtn.querySelector('polyline').setAttribute('points', '9,18 15,12 9,6');
                
                // ‚úÖ MOVER BOT√ìN A LA IZQUIERDA (SOLO EN DESKTOP)
                if (window.innerWidth >= 1024) {
                    toggleBtn.style.left = '20px';
                    toggleBtn.classList.remove('sidebar-open');
                    console.log('üîÑ Bot√≥n movido a la izquierda (desktop)');
                }
                
                sidebarIsOpen = false;
                console.log('üîí Sidebar cerrada');
            } else {
                // ‚úÖ ABRIR SIDEBAR
                sidebar.style.transform = 'translateX(0)';
                toggleBtn.querySelector('polyline').setAttribute('points', '15,18 9,12 15,6');
                
                // ‚úÖ MOVER BOT√ìN A LA DERECHA (SOLO EN DESKTOP)
                if (window.innerWidth >= 1024) {
                    toggleBtn.style.left = '300px';
                    toggleBtn.classList.add('sidebar-open');
                    console.log('üîÑ Bot√≥n movido a la derecha (desktop)');
                }
                
                sidebarIsOpen = true;
                console.log('üîì Sidebar abierta');
            }
        }

        // ‚úÖ FUNCI√ìN MEJORADA PARA CARGAR SIDEBAR
        async function loadSidebar() {
            try {
                console.log('üìÇ Cargando sidebar...');
                const response = await fetch('components/admin-sidebar.html');
                const html = await response.text();
                document.getElementById('sidebar-container').innerHTML = html;
                
                // Esperar un poco m√°s para que el DOM se actualice
                setTimeout(() => {
                    const sidebar = document.querySelector('.admin-sidebar');
                    const toggleBtn = document.querySelector('.sidebar-toggle');
                    
                    if (sidebar) {
                        sidebar.style.transform = 'translateX(-100%)';
                        sidebarIsOpen = false;
                        console.log('‚úÖ Sidebar cargada y cerrada');
                    } else {
                        console.log('‚ö†Ô∏è No se encontr√≥ .admin-sidebar despu√©s de cargar');
                    }
                    
                    if (toggleBtn) {
                        toggleBtn.style.left = '20px';
                        toggleBtn.classList.remove('sidebar-open');
                        console.log('‚úÖ Bot√≥n posicionado para sidebar cerrada');
                    } else {
                        console.log('‚ö†Ô∏è No se encontr√≥ .sidebar-toggle');
                    }
                }, 200);
                
            } catch (error) {
                console.error('‚ùå Error cargando sidebar:', error);
                showNotification('Error cargando el men√∫ lateral', 'error', 3000);
            }
        }

        // Variables globales
        let userToken = localStorage.getItem('token');
        let allUsers = [];
        let filteredUsers = [];

        // Funci√≥n para verificar autenticaci√≥n
        function checkAuth() {
            if (!userToken) {
                console.log('‚ùå No hay token, redirigiendo a login');
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Funci√≥n principal para cargar usuarios
        async function loadUsuarios() {
            console.log('üìã Cargando usuarios...');
            
            if (!checkAuth()) return;

            // ‚úÖ ARREGLAR LLAMADA A showLoading - usar showNotification en su lugar
            showNotification('Cargando usuarios...', 'info', 0);

            try {
                const tbody = document.getElementById('user-table-body');
                const emptyState = document.getElementById('emptyState');
                
                // Mostrar loading
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="admin-loading">
                            <div class="admin-spinner"></div>
                            Cargando usuarios...
                        </td>
                    </tr>
                `;
                emptyState.style.display = 'none';

                console.log('üåê Realizando petici√≥n a /Consultas/api/getusers');
                const response = await fetch('/Consultas/api/getusers', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${userToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üì° Respuesta recibida:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('üìä Datos recibidos:', result);
                
                const users = result.records || [];
                allUsers = users;
                filteredUsers = users;
                
                // Actualizar estad√≠sticas
                updateStatistics(users);

                if (users.length === 0) {
                    tbody.innerHTML = '';
                    emptyState.style.display = 'block';
                    showNotification('No se encontraron usuarios', 'info', 3000);
                    return;
                }

                displayUsers(users);
                console.log(`‚úÖ ${users.length} usuarios cargados exitosamente`);
                
                showNotification(`${users.length} usuarios cargados correctamente`, 'success', 3000);

            } catch (error) {
                console.error('‚ùå Error loading users:', error);
                const tbody = document.getElementById('user-table-body');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: var(--admin-danger); padding: 2rem;">
                            Error al cargar usuarios: ${error.message}
                        </td>
                    </tr>
                `;
                showNotification(`Error al cargar usuarios: ${error.message}`, 'error', 5000);
            }
        }

        // ‚úÖ FUNCI√ìN PARA ACTUALIZAR ESTAD√çSTICAS
        function updateStatistics(users) {
            const totalUsers = users.length;
            const activeUsers = users.filter(user => user.estado === 'A').length;
            const totalRecords = users.reduce((sum, user) => sum + (user.TotalRegistros || 0), 0);

            document.getElementById('userCount').textContent = totalUsers;
            document.getElementById('activeCount').textContent = activeUsers;
            document.getElementById('totalRecords').textContent = totalRecords;
        }

        // Funci√≥n para mostrar usuarios en la tabla
        function displayUsers(users) {
            const tbody = document.getElementById('user-table-body');
            
            if (users.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                tbody.innerHTML = '';
                return;
            }

            document.getElementById('emptyState').style.display = 'none';
            tbody.innerHTML = users.map(user => `
                <tr class="expandable-row" onclick="toggleUserDetails(${user.idUsuario})">
                    <td>
                        <div class="admin-flex admin-items-center admin-gap-2">
                            <div class="admin-avatar" style="width: 32px; height: 32px; font-size: 0.875rem;">
                                ${user.Nombre ? user.Nombre.charAt(0).toUpperCase() : 'U'}
                            </div>
                            <div>
                                <div style="font-weight: 600;">${user.Nombre || 'Sin nombre'} ${user.Apellidos || ''}</div>
                                <div style="font-size: 0.875rem; color: var(--admin-text-secondary);">ID: ${user.idUsuario}</div>
                            </div>
                        </div>
                    </td>
                    <td>${user.email || 'Sin email'}</td>
                    <td>
                        <span class="admin-badge ${getRoleBadgeClass(user.rol)}">
                            ${getRoleText(user.rol)}
                        </span>
                    </td>
                    <td>
                        <span class="admin-badge ${getStatusBadgeClass(user.estado)}">
                            ${getStatusText(user.estado)}
                        </span>
                    </td>
                    <td>
                        <span class="admin-stat-value" style="font-size: 1rem;">
                            ${user.TotalRegistros || 0}
                        </span>
                    </td>
                    <td>
                        <div style="font-size: 0.875rem;">
                            ${user.fechaRegistro ? new Date(user.fechaRegistro).toLocaleDateString('es-ES') : 'Sin fecha'}
                        </div>
                    </td>
                    <td onclick="event.stopPropagation()">
                        <div class="admin-flex admin-gap-2">
                            <button class="admin-btn admin-btn-primary admin-btn-sm" onclick="viewUserDetails(${user.idUsuario})">
                                üëÅÔ∏è Ver
                            </button>
                            <button class="admin-btn admin-btn-secondary admin-btn-sm" onclick="editUser(${user.idUsuario})">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="admin-btn admin-btn-danger admin-btn-sm" onclick="deleteUser(${user.idUsuario})">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </td>
                </tr>
                <tr class="admin-expandable-content" id="details-${user.idUsuario}">
                    <td colspan="7">
                        <div class="admin-expandable-inner">
                            <div class="admin-expandable-header">
                                <h4 class="admin-expandable-title">Registros de ${user.Nombre || 'Usuario'} ${user.Apellidos || ''}</h4>
                                <button class="admin-collapse-btn" onclick="toggleUserDetails(${user.idUsuario})">
                                    Cerrar
                                </button>
                            </div>
                            <div id="registros-${user.idUsuario}" class="admin-loading">
                                <div class="admin-spinner"></div>
                                Cargando registros...
                            </div>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Funci√≥n para filtrar usuarios
        function filterUsers() {
            const statusFilter = document.getElementById('statusFilter').value;
            
            if (statusFilter === '') {
                filteredUsers = allUsers;
            } else {
                filteredUsers = allUsers.filter(user => user.estado === statusFilter);
            }
            
            updateStatistics(filteredUsers);
            displayUsers(filteredUsers);
            
            showNotification(`Filtro aplicado: ${filteredUsers.length} usuarios encontrados`, 'info', 2000);
        }

        // ‚úÖ FUNCI√ìN CORREGIDA PARA ALTERNAR DETALLES DEL USUARIO - USANDO ENDPOINT CORRECTO
        async function toggleUserDetails(userId) {
            const detailsRow = document.getElementById(`details-${userId}`);
            const registrosContainer = document.getElementById(`registros-${userId}`);
            
            if (!detailsRow || !registrosContainer) {
                console.error(`‚ùå No se encontraron elementos para usuario ${userId}`);
                return;
            }
            
            if (detailsRow.classList.contains('show')) {
                detailsRow.classList.remove('show');
                return;
            }

            detailsRow.classList.add('show');
            
            // Cargar registros si no se han cargado
            if (registrosContainer.innerHTML.includes('Cargando registros...')) {
                console.log(`üìã Cargando registros para usuario ${userId}`);
                
                try {
                    // ‚úÖ USAR EL ENDPOINT CORRECTO QUE HACE JOIN CON LAS TABLAS DE REGISTROS
                    const response = await fetch(`/Consultas/api/getRegistrosPorUsuario/${userId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${userToken}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    console.log('üì° Respuesta registros (endpoint correcto):', response.status);

                    if (response.ok) {
                        const results = await response.json();
                        console.log('üìä DATOS COMPLETOS recibidos:', JSON.stringify(results, null, 2));
                        
                        // ‚úÖ VERIFICACI√ìN DE ESTRUCTURA DE DATOS
                        let registros = [];
                        
                        if (results.records && Array.isArray(results.records)) {
                            registros = results.records;
                            console.log('‚úÖ Estructura encontrada: results.records');
                        } else if (results.registros && Array.isArray(results.registros)) {
                            registros = results.registros;
                            console.log('‚úÖ Estructura encontrada: results.registros');
                        } else if (Array.isArray(results)) {
                            registros = results;
                            console.log('‚úÖ Estructura encontrada: Array directo');
                        } else if (results.data && Array.isArray(results.data)) {
                            registros = results.data;
                            console.log('‚úÖ Estructura encontrada: results.data');
                        }
                        
                        console.log(`üìã REGISTROS PROCESADOS: ${registros.length} registros encontrados`);
                        console.log('üìã PRIMER REGISTRO:', registros[0]);
                        
                        if (registros.length === 0) {
                            registrosContainer.innerHTML = `
                                <div style="text-align: center; color: var(--admin-text-secondary); padding: 1rem;">
                                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìù</div>
                                    <p style="margin: 0;">Este usuario no tiene registros de biodiversidad</p>
                                    <div style="margin-top: 1rem; padding: 0.5rem; background: rgba(0, 0, 0, 0.05); border-radius: 4px; font-size: 0.875rem;">
                                        <strong>üìã Respuesta del servidor:</strong><br>
                                        <code style="background: rgba(0,0,0,0.1); padding: 0.25rem 0.5rem; border-radius: 3px; word-break: break-all;">
                                            ${JSON.stringify(results)}
                                        </code>
                                    </div>
                                </div>
                            `;
                        } else {
                            // ‚úÖ TABLA CON MAPEO ESPEC√çFICO PARA LOS DATOS DEL JOIN
                            registrosContainer.innerHTML = `
                                <div style="margin-bottom: 1rem; padding: 0.5rem; background: rgba(72, 204, 108, 0.1); border-radius: 4px;">
                                    <strong>üìä ${registros.length} registros encontrados</strong>
                                    <div style="font-size: 0.875rem; color: var(--admin-text-secondary); margin-top: 0.25rem;">
                                        Endpoint: <code>/getRegistrosPorUsuario/${userId}</code>
                                    </div>
                                </div>
                                <div class="admin-table-container">
                                    <table class="admin-table" style="margin-top: 0;">
                                        <thead>
                                            <tr>
                                                <th>ID Registro</th>
                                                <th>Tipo</th>
                                                <th>Especie/Datos</th>
                                                <th>Fecha</th>
                                                <th>Ubicaci√≥n</th>
                                                <th>Estado</th>
                                                <th>Observaciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${registros.map((registro, index) => {
                                                // ‚úÖ MAPEO ESPEC√çFICO BASADO EN LA ESTRUCTURA DEL JOIN
                                                const idFormulario = registro.idFormIn || registro.idFormulario || registro.id || (index + 1);
                                                const idRegistro = registro.idRegistro || registro.registroId || '';
                                                const tipoRegistro = registro.tipoRegistro || registro.tipo || 'No especificado';
                                                
                                                // Datos espec√≠ficos del tipo de registro
                                                let especieInfo = '';
                                                let observaciones = registro.observaciones || registro.notas || registro.descripcion || '';
                                                let ubicacion = '';
                                                let fecha = registro.fechaRegistro || registro.fecha || registro.created_at || null;
                                                
                                                // ‚úÖ MAPEO SEG√öN EL TIPO DE REGISTRO
                                                if (tipoRegistro.includes('fauna') || tipoRegistro.includes('Fauna')) {
                                                    especieInfo = `
                                                        <div style="font-weight: 600;">${registro.nombreComun || registro.especie || 'Fauna no identificada'}</div>
                                                        ${registro.nombreCientifico ? `<div style="font-size: 0.875rem; font-style: italic; color: var(--admin-text-secondary);">${registro.nombreCientifico}</div>` : ''}
                                                        ${registro.familia ? `<div style="font-size: 0.875rem; color: var(--admin-text-secondary);">Familia: ${registro.familia}</div>` : ''}
                                                    `;
                                                } else if (tipoRegistro.includes('flora') || tipoRegistro.includes('Flora')) {
                                                    especieInfo = `
                                                        <div style="font-weight: 600;">${registro.nombreComun || registro.especie || 'Flora no identificada'}</div>
                                                        ${registro.nombreCientifico ? `<div style="font-size: 0.875rem; font-style: italic; color: var(--admin-text-secondary);">${registro.nombreCientifico}</div>` : ''}
                                                        ${registro.familia ? `<div style="font-size: 0.875rem; color: var(--admin-text-secondary);">Familia: ${registro.familia}</div>` : ''}
                                                    `;
                                                } else if (tipoRegistro.includes('climaticas') || tipoRegistro.includes('clima')) {
                                                    especieInfo = `
                                                        <div style="font-weight: 600;">Variables Clim√°ticas</div>
                                                        ${registro.temperatura ? `<div style="font-size: 0.875rem;">Temp: ${registro.temperatura}¬∞C</div>` : ''}
                                                        ${registro.humedad ? `<div style="font-size: 0.875rem;">Humedad: ${registro.humedad}%</div>` : ''}
                                                        ${registro.precipitacion ? `<div style="font-size: 0.875rem;">Precipitaci√≥n: ${registro.precipitacion}mm</div>` : ''}
                                                    `;
                                                } else {
                                                    // Datos gen√©ricos
                                                    especieInfo = `
                                                        <div style="font-weight: 600;">${registro.nombreComun || registro.especie || registro.descripcion || 'Registro de biodiversidad'}</div>
                                                        ${registro.nombreCientifico ? `<div style="font-size: 0.875rem; font-style: italic; color: var(--admin-text-secondary);">${registro.nombreCientifico}</div>` : ''}
                                                    `;
                                                }
                                                
                                                // ‚úÖ UBICACI√ìN
                                                if (registro.latitud && registro.longitud) {
                                                    ubicacion = `${registro.latitud}, ${registro.longitud}`;
                                                } else if (registro.ubicacion) {
                                                    ubicacion = registro.ubicacion;
                                                } else if (registro.localidad) {
                                                    ubicacion = registro.localidad;
                                                } else if (registro.lugar) {
                                                    ubicacion = registro.lugar;
                                                } else {
                                                    ubicacion = 'Sin ubicaci√≥n';
                                                }
                                                
                                                // ‚úÖ ESTADO
                                                const estado = registro.estado || registro.status || registro.verificado || 'Sin verificar';
                                                
                                                return `
                                                    <tr>
                                                        <td>
                                                            <div style="font-weight: 600;">#${idFormulario}</div>
                                                            ${idRegistro ? `<div style="font-size: 0.875rem; color: var(--admin-text-secondary);">Reg: ${idRegistro}</div>` : ''}
                                                        </td>
                                                        <td>
                                                            <span class="admin-badge admin-badge-info" style="font-size: 0.75rem;">
                                                                ${tipoRegistro}
                                                            </span>
                                                        </td>
                                                        <td style="max-width: 200px;">
                                                            ${especieInfo}
                                                        </td>
                                                        <td>
                                                            <div style="font-size: 0.875rem;">
                                                                ${fecha ? new Date(fecha).toLocaleDateString('es-ES', { 
                                                                    year: 'numeric', 
                                                                    month: 'short', 
                                                                    day: 'numeric',
                                                                    hour: '2-digit',
                                                                    minute: '2-digit'
                                                                }) : 'Sin fecha'}
                                                            </div>
                                                        </td>
                                                        <td style="max-width: 150px;">
                                                            <div style="font-size: 0.875rem; word-wrap: break-word;">
                                                                ${ubicacion}
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <span class="admin-badge ${getRecordStatusBadgeClass(estado)}">
                                                                ${getRecordStatusText(estado)}
                                                            </span>
                                                        </td>
                                                        <td style="max-width: 180px;">
                                                            <div style="font-size: 0.875rem; word-wrap: break-word;">
                                                                ${observaciones || 'Sin observaciones'}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- ‚úÖ DEBUG INFO -->
                                <details style="margin-top: 1rem;">
                                    <summary style="cursor: pointer; padding: 0.5rem; background: rgba(0, 0, 0, 0.05); border-radius: 4px; font-size: 0.875rem;">
                                        <strong>üîç Ver estructura de datos (Debug)</strong>
                                    </summary>
                                    <div style="margin-top: 0.5rem; padding: 1rem; background: rgba(0, 0, 0, 0.05); border-radius: 4px; font-size: 0.875rem;">
                                        <strong>üìã Campos disponibles en el primer registro:</strong><br>
                                        <code style="background: rgba(0,0,0,0.1); padding: 0.5rem; border-radius: 3px; display: block; margin-top: 0.5rem; word-break: break-all; white-space: pre-wrap;">
${registros.length > 0 ? JSON.stringify(registros[0], null, 2) : 'No hay registros'}
                                        </code>
                                    </div>
                                </details>
                            `;
                        }
                    } else {
                        const errorText = await response.text();
                        throw new Error(`Error HTTP ${response.status}: ${errorText}`);
                    }
                } catch (error) {
                    console.error('‚ùå Error loading user records:', error);
                    registrosContainer.innerHTML = `
                        <div style="text-align: center; color: var(--admin-danger); padding: 1rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
                            <p style="margin: 0; font-weight: 600;">Error al cargar registros</p>
                            <p style="margin: 0.5rem 0; font-size: 0.875rem;">${error.message}</p>
                            <p style="margin: 0.5rem 0; font-size: 0.875rem; color: var(--admin-text-secondary);">
                                Endpoint usado: <code>/getRegistrosPorUsuario/${userId}</code>
                            </p>
                            <button class="admin-btn admin-btn-primary admin-btn-sm" onclick="toggleUserDetails(${userId})" style="margin-top: 1rem;">
                                üîÑ Reintentar
                            </button>
                        </div>
                    `;
                    showNotification(`Error cargando registros del usuario ${userId}: ${error.message}`, 'error', 5000);
                }
            }
        }

        // Funciones para obtener clases de badges
        function getRoleBadgeClass(role) {
            switch (parseInt(role)) {
                case 1: return 'admin-badge-info';     // Usuario normal
                case 2: return 'admin-badge-primary';  // EcoRanger
                case 3: return 'admin-badge-success';  // Admin
                case 4: return 'admin-badge-danger';   // Super Admin
                default: return 'admin-badge-info';
            }
        }

        function getRoleText(role) {
            switch (parseInt(role)) {
                case 1: return 'Usuario';
                case 2: return 'EcoRanger';
                case 3: return 'Admin';
                case 4: return 'Super Admin';
                default: return 'Sin rol';
            }
        }

        function getStatusBadgeClass(status) {
            switch (status) {
                case 'A': return 'admin-badge-success';  // Activo
                case 'I': return 'admin-badge-warning';  // Inactivo
                case 'P': return 'admin-badge-info';     // Pendiente
                case 'S': return 'admin-badge-danger';   // Suspendido
                default: return 'admin-badge-info';
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'A': return 'Activo';
                case 'I': return 'Inactivo';
                case 'P': return 'Pendiente';
                case 'S': return 'Suspendido';
                default: return 'Sin estado';
            }
        }

        // ‚úÖ FUNCIONES PARA BADGES DE REGISTROS
        function getRecordStatusBadgeClass(status) {
            const statusStr = String(status).toLowerCase();
            switch (statusStr) {
                case 'verificado':
                case 'approved':
                case 'activo':
                case 'a':
                case 'valid':
                case 'true':
                case '1': 
                    return 'admin-badge-success';
                case 'pendiente':
                case 'pending':
                case 'p':
                case 'review':
                case 'false':
                case '0': 
                    return 'admin-badge-warning';
                case 'rechazado':
                case 'rejected':
                case 'inactivo':
                case 'i':
                case 'invalid': 
                    return 'admin-badge-danger';
                default: 
                    return 'admin-badge-info';
            }
        }

       function getRecordStatusText(status) {
            const statusStr = String(status).toLowerCase();
            switch (statusStr) {
                case 'verificado':
                case 'approved':
                case 'activo':
                case 'a':
                case 'valid':
                case 'true':
                case '1': 
                    return 'Verificado';
                case 'pendiente':
                case 'pending':
                case 'p':
                case 'review':
                case 'false':
                case '0': 
                    return 'Pendiente';
                case 'rechazado':
                case 'rejected':
                case 'inactivo':
                case 'i':
                case 'invalid': 
                    return 'Rechazado';
                default: 
                    return status || 'Sin verificar';
            }
        }

        // Funciones de acciones (placeholder)
        function viewUserDetails(userId) {
            showNotification(`Ver detalles del usuario ${userId} - Funci√≥n en desarrollo`, 'info', 3000);
        }

        function editUser(userId) {
            showNotification(`Editar usuario ${userId} - Funci√≥n en desarrollo`, 'info', 3000);
        }

        function deleteUser(userId) {
            if (confirm(`¬øEst√°s seguro de que quieres eliminar el usuario ${userId}?`)) {
                showNotification(`Eliminar usuario ${userId} - Funci√≥n en desarrollo`, 'warning', 3000);
            }
        }

        // Funci√≥n para cerrar sesi√≥n
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userData');
            showInfo('Cerrando sesi√≥n...', 2000);
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 1500);
        }

        // ‚úÖ INICIALIZACI√ìN MEJORADA
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ Inicializando p√°gina AdmUpReguser...');
            
            if (!checkAuth()) {
                return;
            }

            // Cargar sidebar primero
            loadSidebar();

            // Cargar usuarios despu√©s de que la sidebar est√© lista
            setTimeout(() => {
                loadUsuarios();
            }, 1500);

            // Actualizar informaci√≥n del usuario si est√° disponible
            const userData = localStorage.getItem('userData');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    const userNameElement = document.getElementById('userName');
                    const userAvatarElement = document.getElementById('userAvatar');
                    
                    if (user.name && userNameElement) {
                        userNameElement.textContent = user.name;
                    }
                    if (user.name && userAvatarElement) {
                        userAvatarElement.textContent = user.name.charAt(0).toUpperCase();
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è Error parsing user data:', e);
                }
            }

            // Mensaje de bienvenida
            setTimeout(() => {
                showNotification('Gesti√≥n de usuarios cargada correctamente', 'success', 2000);
            }, 2000);
        });

        // ‚úÖ AJUSTAR POSICI√ìN DEL BOT√ìN AL REDIMENSIONAR VENTANA
        window.addEventListener('resize', function() {
            const toggleBtn = document.querySelector('.sidebar-toggle');
            if (toggleBtn) {
                if (window.innerWidth < 1024) {
                    // En m√≥vil, siempre a la izquierda
                    toggleBtn.style.left = '20px';
                    toggleBtn.classList.remove('sidebar-open');
                    console.log('üì± Modo m√≥vil: bot√≥n fijo a la izquierda');
                } else {
                    // En desktop, depende del estado de la sidebar
                    if (sidebarIsOpen) {
                        toggleBtn.style.left = '300px';
                        toggleBtn.classList.add('sidebar-open');
                        console.log('üíª Modo desktop: bot√≥n a la derecha (sidebar abierta)');
                    } else {
                        toggleBtn.style.left = '20px';
                        toggleBtn.classList.remove('sidebar-open');
                        console.log('üíª Modo desktop: bot√≥n a la izquierda (sidebar cerrada)');
                    }
                }
            }
        });

        // ‚úÖ CERRAR SIDEBAR AL HACER CLIC FUERA (M√ìVIL)
        document.addEventListener('click', function(e) {
            if (window.innerWidth < 1024 && sidebarIsOpen) {
                const sidebar = document.querySelector('.admin-sidebar');
                const toggleBtn = document.querySelector('.sidebar-toggle');
                
                if (sidebar && 
                    !sidebar.contains(e.target) && 
                    !toggleBtn.contains(e.target)) {
                    toggleSidebar();
                }
            }
        });

        // ‚úÖ FUNCIONES DE NOTIFICACI√ìN SIMPLIFICADAS
        function showNotification(message, type = 'info', duration = 3000) {
            // Crear notificaci√≥n si no existe el sistema
            if (typeof showSuccess === 'undefined') {
                console.log(`${type.toUpperCase()}: ${message}`);
                
                // Crear notificaci√≥n visual simple
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    color: white;
                    font-weight: 500;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
                `;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                if (duration > 0) {
                    setTimeout(() => {
                        notification.remove();
                    }, duration);
                }
                
                return;
            }
            
            // Usar sistema de notificaciones existente
            switch (type) {
                case 'success':
                    showSuccess(message, duration);
                    break;
                case 'error':
                    showError(message, duration);
                    break;
                case 'warning':
                    showWarning(message, duration);
                    break;
                default:
                    showInfo(message, duration);
            }
        }
    </script>
</body>
</html>